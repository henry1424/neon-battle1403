<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Neon Battle - Boss & Sword Fix</title>
    <style>
        :root {
            --neon-player: #00ffcc;
            --neon-enemy: #ff0044;
            --neon-boss: #ff00ff;
            --neon-alert: #ffcc00;
            --neon-shield: #00ff44;
        }
        body { margin: 0; overflow: hidden; background: #050505; color: var(--neon-player); font-family: 'Courier New', monospace; }
        canvas { display: block; }
        
        #ui, #menu-inicial, #tela-morte {
            position: absolute; background: rgba(0, 10, 10, 0.95); 
            border: 1px solid var(--neon-player); border-radius: 4px;
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.2);
        }

        #ui { top: 20px; left: 20px; padding: 15px; min-width: 220px; z-index: 5; display: none; }
        #menu-inicial { top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 40px; text-align: center; z-index: 20; min-width: 320px; }
        #tela-morte { display: none; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 40px; text-align: center; z-index: 100; border-color: var(--neon-enemy); }

        #boss-ui { 
            display: none; position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 60%; text-align: center; z-index: 10;
        }
        .boss-bar { width: 100%; height: 15px; background: #111; border: 2px solid var(--neon-boss); box-shadow: 0 0 15px var(--neon-boss); }
        #boss-hp { width: 100%; height: 100%; background: var(--neon-boss); transition: width 0.1s; }

        h1 { font-size: 32px; margin-bottom: 20px; text-shadow: 0 0 10px var(--neon-player); }
        button { background: var(--neon-player); border: none; padding: 15px 30px; cursor: pointer; font-family: monospace; font-weight: bold; font-size: 18px; transition: 0.3s; margin-top: 15px; }
        button:hover { background: #fff; box-shadow: 0 0 25px #fff; transform: scale(1.05); }
        .barra-dash { width: 100%; height: 6px; background: #111; border: 1px solid var(--neon-player); margin-top: 8px; }
        #carga-dash { width: 100%; height: 100%; background: var(--neon-player); }
    </style>
</head>
<body>

    <div id="menu-inicial">
        <h1>NEON BATTLE</h1>
        <div style="text-align: left; padding: 10px; border-top: 1px solid #222;">
            <label>COR DO PERSONAGEM:</label>
            <input type="color" id="cfgCor" value="#00ffcc" style="width:100%; height:40px; background:none; border:1px solid #444; cursor:pointer;">
            <br><br>
            <label>DIFICULDADE INICIAL:</label>
            <input type="range" id="cfgVel" min="1" max="8" step="0.5" value="2.5" style="width:100%;">
        </div>
        <button onclick="iniciarJogo()">INICIAR SISTEMA</button>
    </div>

    <div id="boss-ui">
        <div style="color: var(--neon-boss); font-weight: bold; margin-bottom: 5px; letter-spacing: 2px;">BOSS DETECTADO</div>
        <div class="boss-bar"><div id="boss-hp"></div></div>
    </div>

    <div id="ui">
        <div style="display: flex; justify-content: space-between;"><span>SISTEMA:</span> <span id="txtNivel">NÍVEL 01</span></div>
        <div style="display: flex; justify-content: space-between;"><span>ABATES:</span> <span id="txtAbates">0</span></div>
        <div style="display: flex; justify-content: space-between;"><span>TEMPO:</span> <span id="txtTempo">0</span>s</div>
        <div id="msg" style="color: var(--neon-alert); margin-top: 10px; font-size: 11px; height: 15px;"></div>
        <div class="barra-dash"><div id="carga-dash"></div></div>
    </div>

    <div id="tela-morte">
        <h1 style="color: var(--neon-enemy);">SISTEMA CRÍTICO</h1>
        <h2 id="final-score" style="color:#fff">SCORE: 0</h2>
        <button onclick="location.reload()">REBOOT</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
    let CONFIG = { PLAYER_VEL_BASE: 5, DASH_VEL: 25, COR_PLAYER: "#00ffcc", INIMIGO_VEL_BASE: 2.5 };
    let jogoIniciado = false, jogoAtivo = true, abates = 0, tempoInicio, bossAtivo = false;
    let proximoBoss = 10; // Próximo objetivo para o boss aparecer
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    let player, inimigo, boss, itens = [], tirosP = [], tirosI = [], teclas = {};
    let anguloFacas = 0;

    function ajustar() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = ajustar; ajustar();

    function iniciarJogo() {
        CONFIG.COR_PLAYER = document.getElementById("cfgCor").value;
        CONFIG.INIMIGO_VEL_BASE = parseFloat(document.getElementById("cfgVel").value);
        document.documentElement.style.setProperty('--neon-player', CONFIG.COR_PLAYER);
        player = { x: 100, y: 100, tam: 30, vel: CONFIG.PLAYER_VEL_BASE, arma: false, facas: false, escudo: false, dashCooldown: 0, isDashing: false };
        inimigo = { x: canvas.width - 100, y: canvas.height - 100, tam: 40, vel: CONFIG.INIMIGO_VEL_BASE, vivo: true, recarga: 0 };
        spawnItem("arma");
        setInterval(() => { if(jogoAtivo && jogoIniciado) spawnItem(["speed", "faca", "escudo"][Math.floor(Math.random()*3)]); }, 7000);
        tempoInicio = Date.now(); jogoIniciado = true;
        document.getElementById("menu-inicial").style.display = "none";
        document.getElementById("ui").style.display = "block";
        loop();
    }

    function spawnBoss() {
        if(bossAtivo) return;
        bossAtivo = true;
        inimigo.vivo = false; 
        let vidaExtra = Math.floor(abates / 10) * 5;
        boss = { x: canvas.width/2 - 50, y: -150, tam: 100, hpMax: 20 + vidaExtra, hp: 20 + vidaExtra, vel: 1.5, recarga: 0 };
        document.getElementById("boss-ui").style.display = "block";
        document.getElementById("boss-hp").style.width = "100%";
        msg("BOSS NÍVEL " + (Math.floor(abates/10) + 1));
        proximoBoss += 10; // Define a meta para o próximo Boss
    }

    function spawnItem(tipo) {
        itens.push({ x: Math.random()*(canvas.width-100)+50, y: Math.random()*(canvas.height-100)+50, tam: 20, tipo: tipo, cor: tipo==="arma"?"#fff":tipo==="speed"?"#ffff00":tipo==="faca"?"#0088ff":"#00ff44" });
    }

    window.onkeydown = e => { teclas[e.key.toLowerCase()] = true; if(e.key.toLowerCase()==='q' && player.dashCooldown <= 0 && jogoIniciado) { player.isDashing=true; player.dashCooldown=120; setTimeout(()=>player.isDashing=false, 200); } };
    window.onkeyup = e => teclas[e.key.toLowerCase()] = false;

    function atirar(origem, alvoX, alvoY, lista, v) {
        let dx = alvoX - (origem.x + origem.tam/2);
        let dy = alvoY - (origem.y + origem.tam/2);
        let d = Math.sqrt(dx*dx + dy*dy);
        if(d === 0) return;
        lista.push({ x: origem.x+origem.tam/2, y: origem.y+origem.tam/2, vx: (dx/d)*v, vy: (dy/d)*v });
    }

    function colisao(a, b) {
        let tA = a.tam || 6; let tB = b.tam || 6;
        return a.x < b.x + tB && a.x + tA > b.x && a.y < b.y + tB && a.y + tA > b.y;
    }

    function loop() {
        if (!jogoAtivo) return;
        document.getElementById("txtTempo").innerText = Math.floor((Date.now() - tempoInicio) / 1000);
        let v = player.isDashing ? CONFIG.DASH_VEL : player.vel;
        
        if (teclas['w'] && player.y > 0) player.y -= v;
        if (teclas['s'] && player.y < canvas.height - player.tam) player.y += v;
        if (teclas['a'] && player.x > 0) player.x -= v;
        if (teclas['d'] && player.x < canvas.width - player.tam) player.x += v;
        
        if (player.dashCooldown > 0) { 
            player.dashCooldown--; 
            document.getElementById("carga-dash").style.width = (100 - (player.dashCooldown/120)*100) + "%"; 
        }

        // VELOCIDADE DAS ESPADAS EM 0.3
        anguloFacas += 0.3;

        ctx.fillStyle = "black"; ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Verificação constante para o Boss
        if (abates >= proximoBoss && !bossAtivo) {
            spawnBoss();
        }

        if (bossAtivo) {
            if (boss.y < 80) boss.y += 2;
            if (boss.x < player.x) boss.x += boss.vel; else boss.x -= boss.vel;
            if (++boss.recarga > 80) {
                for(let i=0; i<8; i++) {
                    let ang = (i * Math.PI / 4);
                    tirosI.push({ x: boss.x+boss.tam/2, y: boss.y+boss.tam/2, vx: Math.cos(ang)*6, vy: Math.sin(ang)*6 });
                }
                boss.recarga = 0;
            }
            ctx.fillStyle = "#ff00ff"; ctx.shadowBlur = 25; ctx.shadowColor = "#ff00ff";
            ctx.fillRect(boss.x, boss.y, boss.tam, boss.tam);
            if (colisao(player, boss) && !player.escudo) morrer();
        } 
        
        if (!bossAtivo && inimigo.vivo) {
            if (inimigo.x < player.x) inimigo.x += inimigo.vel; else inimigo.x -= inimigo.vel;
            if (inimigo.y < player.y) inimigo.y += inimigo.vel; else inimigo.y -= inimigo.vel;
            if (++inimigo.recarga > 90) { atirar(inimigo, player.x+15, player.y+15, tirosI, 5); inimigo.recarga = 0; }
            if (colisao(player, inimigo) && !player.escudo) morrer();
            ctx.fillStyle = CONFIG.COR_ENEMY; ctx.shadowBlur = 15; ctx.shadowColor = CONFIG.COR_ENEMY;
            ctx.fillRect(inimigo.x, inimigo.y, inimigo.tam, inimigo.tam);
        }

        itens.forEach((item, idx) => {
            ctx.fillStyle = item.cor; ctx.shadowBlur = 15; ctx.shadowColor = item.cor;
            if(item.tipo === "speed" || item.tipo === "escudo") { ctx.beginPath(); ctx.arc(item.x, item.y, 10, 0, Math.PI*2); ctx.fill(); }
            else ctx.fillRect(item.x, item.y, item.tam, item.tam);
            if (colisao(player, item)) { aplicarPoder(item.tipo); itens.splice(idx, 1); }
        });

        if (player.escudo) {
            ctx.strokeStyle = "#00ff44"; ctx.lineWidth = 3; ctx.shadowBlur = 15; ctx.shadowColor = "#00ff44";
            ctx.beginPath(); ctx.arc(player.x + player.tam/2, player.y + player.tam/2, 45, 0, Math.PI*2); ctx.stroke();
        }

        if (player.facas) {
            for(let i=0; i<2; i++) {
                let fX = player.x + player.tam/2 + Math.cos(anguloFacas + (i * Math.PI)) * 80;
                let fY = player.y + player.tam/2 + Math.sin(anguloFacas + (i * Math.PI)) * 80;
                ctx.fillStyle = "#0088ff"; ctx.shadowBlur = 10; ctx.shadowColor = "#0088ff";
                ctx.fillRect(fX - 6, fY - 6, 12, 12);
                if (bossAtivo && colisao({x: fX-6, y: fY-6, tam: 12}, boss)) hitBoss();
                if (!bossAtivo && inimigo.vivo && colisao({x: fX-6, y: fY-6, tam: 12}, inimigo)) matarInimigo();
            }
        }

        ctx.fillStyle = player.isDashing ? "#fff" : CONFIG.COR_PLAYER;
        ctx.shadowColor = ctx.fillStyle; ctx.shadowBlur = 15;
        ctx.fillRect(player.x, player.y, player.tam, player.tam);

        ctx.shadowBlur = 0;
        tirosP.forEach((t, i) => {
            t.x += t.vx; t.y += t.vy; ctx.fillStyle = CONFIG.COR_PLAYER; ctx.fillRect(t.x, t.y, 6, 6);
            if (bossAtivo && colisao(t, boss)) { hitBoss(); tirosP.splice(i, 1); }
            else if (!bossAtivo && inimigo.vivo && colisao(t, inimigo)) { matarInimigo(); tirosP.splice(i, 1); }
            if (t.x < 0 || t.x > canvas.width || t.y < 0 || t.y > canvas.height) tirosP.splice(i, 1);
        });

        tirosI.forEach((t, i) => {
            t.x += t.vx; t.y += t.vy; ctx.fillStyle = "yellow"; ctx.fillRect(t.x, t.y, 6, 6);
            if (player.escudo) {
                let d = Math.sqrt(Math.pow(t.x-(player.x+15),2)+Math.pow(t.y-(player.y+15),2));
                if (d < 45) { tirosI.splice(i, 1); return; }
            }
            if (colisao(t, player)) morrer();
            if (t.x < 0 || t.x > canvas.width || t.y < 0 || t.y > canvas.height) tirosI.splice(i, 1);
        });

        if (teclas[' '] && player.arma) { 
            let alvo = bossAtivo ? {x: boss.x+50, y: boss.y+50} : (inimigo.vivo ? {x: inimigo.x+20, y: inimigo.y+20} : null);
            if(alvo) atirar(player, alvo.x, alvo.y, tirosP, 12); 
            teclas[' '] = false; 
        }

        requestAnimationFrame(loop);
    }

    function hitBoss() {
        boss.hp--;
        document.getElementById("boss-hp").style.width = (boss.hp / boss.hpMax * 100) + "%";
        if (boss.hp <= 0) {
            bossAtivo = false; abates += 5; // Bônus
            document.getElementById("boss-ui").style.display = "none";
            document.getElementById("txtAbates").innerText = abates;
            msg("BOSS DESTRUÍDO!");
            setTimeout(() => { if(jogoAtivo) inimigo.vivo = true; }, 1000);
        }
    }

    function matarInimigo() {
        inimigo.vivo = false; abates++;
        document.getElementById("txtAbates").innerText = abates;
        
        if (abates % 10 === 0) { 
            inimigo.vel += 0.5; 
            document.getElementById("txtNivel").innerText = "NÍVEL " + (Math.floor(abates/10) + 1);
        }
        
        setTimeout(() => { if(!bossAtivo && jogoAtivo) inimigo.vivo = true; }, 800);
    }

    function aplicarPoder(tipo) {
        if(tipo === "arma") player.arma = true;
        if(tipo === "speed") { player.vel = 9; setTimeout(() => player.vel = CONFIG.PLAYER_VEL_BASE, 5000); }
        if(tipo === "faca") { player.facas = true; setTimeout(() => player.facas = false, 10000); }
        if(tipo === "escudo") { player.escudo = true; setTimeout(() => player.escudo = false, 8000); }
        msg(tipo + " ativado!");
    }

    function msg(t) { document.getElementById("msg").innerText = t; }
    function morrer() { jogoAtivo = false; document.getElementById("tela-morte").style.display = "block"; document.getElementById("final-score").innerText = "SCORE: " + abates; }
    </script>
</body>
</html>